<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Venda</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">Home</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">
              Menu
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_serviços.html">Serviços</a></li>
              <li><a class="dropdown-item" href="buscar_vendas.html">Vendas</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  
  <div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Detalhes da Venda</h2>
      <div>
        <a href="buscar_vendas.html" class="btn btn-secondary me-2">Voltar</a>
        <button class="btn btn-primary me-2" type="button" id="btn-editar" onclick="editarVenda()">Editar</button>
        <button class="btn btn-danger" type="button" id="btn-excluir" onclick="excluirVenda()">Excluir</button>
        <button class="btn btn-primary me-2" type="button"  onclick="irParaPagamento()"> Pagar Parcelas </button>
</button>

      </div>
    </div>

    
    <div class="card mb-3">
      <div class="card-body">
        <h5>Informações Gerais</h5>
        <div id="info-geral" class="row g-2">
          <!-- preenchido via JS -->
        </div>
      </div>
    </div>

    
    <div class="card mb-3">
      <div class="card-body">
        <h5>Cliente</h5>
        <div id="info-cliente" class="row g-2">
          <!-- preenchido via JS -->
        </div>
      </div>
    </div>

    
    <div class="card mb-3">
      <div class="card-body">
        <h5>Produtos da Venda</h5>
        <div class="table-responsive">
          <table class="table table-striped text-center align-middle" id="tabela-produtos-venda">
            <thead class="table-secondary">
              <tr>
                <th>Produto</th>
                <th>Código</th>
                <th>Qtd</th>
                <th>Preço Unit. na Venda</th>
                <th>Desconto Unit. (%)</th>
                <th>Total (R$)</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

   
    <div class="card mb-3">
      <div class="card-body">
        <h5>Serviços da Venda</h5>
        <div class="table-responsive">
          <table class="table table-striped text-center align-middle" id="tabela-servicos-venda">
            <thead class="table-secondary">
              <tr>
                <th>Serviço</th>
                <th>Código</th>
                <th>Preço na Venda</th>
                <th>Desconto (%)</th>
                <th>Total (R$)</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    
    <div class="card mb-3">
      <div class="card-body">
        <h5>Transação / Pagamento</h5>
        <div id="info-transacao" class="row g-2">
          <!-- JS -->
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "https://localhost:7036";
    let vendaGlobal = null; // guardo pra usar no excluir/editar

    function mostrarAviso(msg, tipo) {
      const aviso = document.createElement("div");
      aviso.className = `alert ${tipo === "sucesso" ? "alert-success" : "alert-warning"} position-fixed top-0 end-0 m-3`;
      aviso.style.zIndex = "9999";
      aviso.textContent = msg;
      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 4000);
    }

    function obterParametroUrl(nome) {
      const params = new URLSearchParams(window.location.search);
      return params.get(nome);
    }

    function obterNomeCliente(cliente) {
      if (!cliente) return "—";
      return cliente.nome || cliente.razaoSocial || "—";
    }

    function formatarData(dataIsoOuString) {
      if (!dataIsoOuString) return "—";
      const d = new Date(dataIsoOuString);
      if (isNaN(d)) return dataIsoOuString;
      return d.toLocaleString("pt-BR");
    }

    function preencherInfoGeral(venda, transacao) {
      const div = document.getElementById("info-geral");
      div.innerHTML = `
        <div class="col-md-3"><strong>ID Venda:</strong> ${venda.idVenda}</div>
        <div class="col-md-3"><strong>Data:</strong> ${formatarData(venda.dataCriacao)}</div>
        <div class="col-md-3"><strong>Desconto Geral (%):</strong> ${venda.desconto}</div>
        <div class="col-md-3"><strong>Total com Desconto (R$):</strong> ${venda.valorTotalComDescontoAplicado.toFixed(2)}</div>
      `;
    }

    function preencherInfoCliente(cliente) {
      const div = document.getElementById("info-cliente");
      div.innerHTML = `
        <div class="col-md-4"><strong>Nome/Razão Social:</strong> ${obterNomeCliente(cliente)}</div>
        <div class="col-md-4"><strong>CPF/CNPJ:</strong> ${cliente.cpf || cliente.cnpj || "—"}</div>
        <div class="col-md-4"><strong>Email:</strong> ${cliente.email || "—"}</div>
        <div class="col-md-4"><strong>Telefone:</strong> ${cliente.telefone || "—"}</div>
        <div class="col-md-4"><strong>Cidade:</strong> ${cliente.endereco?.cidade || "—"}</div>
        <div class="col-md-4"><strong>UF:</strong> ${cliente.endereco?.siglaUf || "—"}</div>
      `;
    }

    function preencherTabelaProdutos(itensVenda) {
      const tbody = document.querySelector("#tabela-produtos-venda tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(itensVenda) || itensVenda.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Nenhum produto nesta venda.</td></tr>`;
        return;
      }

      itensVenda.forEach(item => {
        const produto = item.produto || {};
        const nome = produto.nomeProduto || "—";
        const codigo = produto.codigoDeBarra || "—";
        const qtd = item.quantidade ?? 0;
        const precoNaVenda = item.precoUnitarioNaVenda ?? produto.precoUnitario ?? 0;
        const desc = item.descontoUnitario ?? 0;
        const total = qtd * precoNaVenda * (1 - desc / 100);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${nome}</td>
          <td>${codigo}</td>
          <td>${qtd}</td>
          <td>R$ ${precoNaVenda.toFixed(2)}</td>
          <td>${desc}%</td>
          <td>R$ ${total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function preencherTabelaServicos(servicosVenda) {
      const tbody = document.querySelector("#tabela-servicos-venda tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(servicosVenda) || servicosVenda.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Nenhum serviço nesta venda.</td></tr>`;
        return;
      }

      servicosVenda.forEach(item => {
        const servico = item.servico || {};
        const nome = servico.nomeServico || "—";
        const codigo = servico.codigoDoServico || "—";
        const precoNaVenda = item.precoServicoNaVenda ?? servico.precoUnitario ?? servico.precoServico ?? 0;
        const desc = item.descontoServico ?? 0;
        const total = precoNaVenda * (1 - desc / 100);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${nome}</td>
          <td>${codigo}</td>
          <td>R$ ${precoNaVenda.toFixed(2)}</td>
          <td>${desc}%</td>
          <td>R$ ${total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function preencherInfoTransacao(transacao) {
        const div = document.getElementById("info-transacao");

        if (!transacao) {
            div.innerHTML = `<div class="col-12 text-muted">Nenhuma transação registrada.</div>`;
            return;
        }

        const situacao = transacao.pago
            ? "Paga"
            : (transacao.transacaoEmCurso ? "Em andamento" : "Em aberto");

        div.innerHTML = `
            <div class="col-md-3"><strong>ID Transação:</strong> ${transacao.idTransacao}</div>
            <div class="col-md-3"><strong>Data:</strong> ${formatarData(transacao.dataCriacao)}</div>
            <div class="col-md-3"><strong>Tipo Pagamento:</strong> ${transacao.tipoPagamento}</div>
            <div class="col-md-3"><strong>Meio Pagamento:</strong> ${transacao.meioPagamento}</div>
            <div class="col-md-3"><strong>Parcelas:</strong> ${transacao.numeroDeParcelas}</div>
            <div class="col-md-3"><strong>Pagas:</strong> ${transacao.numeroDeParcelasPagas}</div>
            <div class="col-md-3"><strong>Valor Pago (R$):</strong> ${transacao.valorPago?.toFixed(2) || "0.00"}</div>
            <div class="col-md-3"><strong>Situação:</strong> ${situacao}</div>
        `;

        // DESATIVA EXCLUIR SE A VENDA ESTIVER PAGA
        const btnExcluir = document.getElementById("btn-excluir");
        const btnEditar = document.getElementById("btn-editar");

        if (transacao.numeroDeParcelasPagas > 0) {

            btnExcluir.disabled = true;
            btnExcluir.title = "Venda paga não pode ser excluída.";

            btnEditar.disabled = true;
            btnEditar.title = "Venda paga não pode ser editada.";
        }
        }


    async function carregarVenda() {
      const id = obterParametroUrl("id");
      if (!id) {
        mostrarAviso("ID da venda não informado.", "erro");
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/api/venda/${encodeURIComponent(id)}`);
        if (!resp.ok) throw new Error(`Erro ${resp.status}: não foi possível carregar a venda.`);
        const dados = await resp.json(); 

        vendaGlobal = dados;

        const venda = dados.venda || {};
        const transacao = dados.transacao || {};
        const cliente = venda.cliente || {};

        preencherInfoGeral(venda, transacao);
        preencherInfoCliente(cliente);
        preencherTabelaProdutos(venda.itensVenda || []);
        preencherTabelaServicos(venda.servicosVenda || []);
        preencherInfoTransacao(transacao);
      } catch (erro) {
        console.error(erro);
        mostrarAviso("Erro ao carregar dados da venda.", "erro");
      }
    }

    function editarVenda() {
        if (!vendaGlobal) {
            return mostrarAviso("Venda não carregada.", "erro");
        }

        
        const id =
            vendaGlobal?.venda?.idVenda ||
            vendaGlobal?.idVenda ||
            null;

        console.log("vendaGlobal usado no editarVenda:", vendaGlobal);
        console.log("ID de venda detectado para edição:", id);

        if (!id) {
            return mostrarAviso("Não foi possível identificar o ID da venda para edição.", "erro");
        }

        
        window.location.href = "editar_venda.html?id=" + encodeURIComponent(id);
        }

     function irParaPagamento() {
        if (!vendaGlobal || !vendaGlobal.venda) {
            return mostrarAviso("Venda não carregada.", "erro");
        }
        const idVenda = vendaGlobal.venda.idVenda;
        window.location.href = "pagar_parcelas.html?id=" + encodeURIComponent(idVenda);
        }



    async function excluirVenda() {
      if (!vendaGlobal || !vendaGlobal.venda) {
        return mostrarAviso("Venda não carregada.", "erro");
      }

      const transacao = vendaGlobal.transacao;
      if (transacao && transacao.pago) {
        return mostrarAviso("Venda paga não pode ser excluída.", "erro");
      }

      const id = vendaGlobal.venda.idVenda;

      if (!confirm("Tem certeza que deseja excluir esta venda?")) return;

      try {
        const resp = await fetch(`${API_BASE}/api/venda/${encodeURIComponent(id)}`, {
          method: "DELETE"
        });

        const texto = await resp.text();

        if (!resp.ok) {
          throw new Error(texto || "Erro ao excluir venda.");
        }

        mostrarAviso("Venda excluída com sucesso!", "sucesso");
        setTimeout(() => {
          window.location.href = "buscar_vendas.html";
        }, 1500);
      } catch (erro) {
        console.error(erro);
        mostrarAviso(erro.message, "erro");
      }
    }

    document.addEventListener("DOMContentLoaded", carregarVenda);
  </script>
</body>
</html>
