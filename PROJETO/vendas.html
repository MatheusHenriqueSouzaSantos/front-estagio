<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  
  
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">Home</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">Menu</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_servi√ßos.html">Servi√ßos</a></li>
              <li><a class="dropdown-item active" href="buscar_vendas.html">Vendas</a></li>
              <li><a class="dropdown-item" href="relatorios.html">Relat√≥rios</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4 px-5">
    <h2 class="text-center mb-4">Nova Venda</h2>

    <form id="form-venda" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Nome do Cliente:</label>
          <input type="text" id="input-nomeCliente" class="form-control" placeholder="Digite o nome do cliente">
        </div>

        <div class="col-md-3">
          <label class="form-label">CPF do Cliente (opcional):</label>
          <input type="text" id="input-cpfCliente" class="form-control" placeholder="000.000.000-00">
          <div class="form-text"></div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Desconto Geral (R$):</label>
          <input
            type="number"
            id="input-desconto"
            class="form-control"
            value="0"
            min="0"
            step="0.01">
        </div>

        <div class="col-md-3 text-end">
          <button type="button" class="btn btn-success w-100" onclick="finalizarVenda()">
             üíæ Finalizar Venda
          </button>

        </div>
      </div>

      <input type="hidden" id="input-idCliente" value="">
    </form>

    <hr>

    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Produtos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalProduto()">+ Adicionar Produto</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-produtos">
        <thead class="table-secondary">
          <tr>
            <th>Produto</th>
            <th>C√≥digo de Barra</th>
            <th>Qtd</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Servi√ßos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalServico()">+ Adicionar Servi√ßo</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-servicos">
        <thead class="table-secondary">
          <tr>
            <th>Servi√ßo</th>
            <th>C√≥digo</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-venda mb-4">
      <h5>Transa√ß√£o / Pagamento</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Tipo de Pagamento:</label>
          <select id="tipo-pagamento" class="form-select">
            <option value="0">√Ä Vista</option>
            <option value="1">A Prazo</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Meio de Pagamento:</label>
          <select id="meio-pagamento" class="form-select">
            <option value="0">Dinheiro</option>
            <option value="1">Cart√£o de D√©bito</option>
            <option value="2">Cart√£o de Cr√©dito</option>
            <option value="3">Pix</option>
            <option value="4">Boleto</option>
            <option value="5">Transfer√™ncia Banc√°ria</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Parcelas:</label>
          <input type="number" id="parcelas" class="form-control" value="1" min="1">
        </div>
      </div>
    </div>

    <hr>
    <div class="text-end">
      <h4>Total da Venda: R$ <span id="valor-total">0.00</span></h4>
    </div>
  </div>

  <div class="modal fade" id="modalProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5 class="mb-3">Adicionar Produto</h5>

        <div class="mb-2">
          <label class="form-label">Nome do Produto</label>
          <div class="input-group">
            <input type="text" id="mp-busca" class="form-control" placeholder="Digite parte do nome">
            <button class="btn btn-outline-secondary" type="button" onclick="buscarProdutoModal()">Buscar</button>
          </div>
        </div>

        <input type="hidden" id="mp-id-produto">

        <div class="mb-2">
          <label class="form-label">Nome</label>
          <input type="text" id="mp-nome" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">C√≥digo</label>
          <input type="text" id="mp-codigo" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Quantidade</label>
          <input type="number" id="mp-qtd" class="form-control" value="1" min="1">
        </div>

        <div class="mb-2">
          <label class="form-label">Pre√ßo Unit√°rio (R$)</label>
          <input type="number" id="mp-preco" class="form-control" min="0" step="0.01" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Desconto Unit√°rio (%)</label>
          <input type="number" id="mp-desc" class="form-control" min="0" value="0">
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-sm" onclick="confirmarProduto()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalServico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5 class="mb-3">Adicionar Servi√ßo</h5>

        <div class="mb-2">
          <label class="form-label">Nome do Servi√ßo</label>
          <div class="input-group">
            <input type="text" id="ms-busca" class="form-control" placeholder="Digite parte do nome">
            <button class="btn btn-outline-secondary" type="button" onclick="buscarServicoModal()">Buscar</button>
          </div>
        </div>

        <input type="hidden" id="ms-id-servico">

        <div class="mb-2">
          <label class="form-label">Nome</label>
          <input type="text" id="ms-nome" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">C√≥digo</label>
          <input type="text" id="ms-codigo" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Pre√ßo (R$)</label>
          <input type="number" id="ms-preco" class="form-control" min="0" step="0.01" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Desconto (%)</label>
          <input type="number" id="ms-desc" class="form-control" min="0" value="0">
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-sm" onclick="confirmarServico()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "https://localhost:7036";

    let produtos = [];
    let servicos = [];
    let modalProduto;
    let modalServico;

    function mostrarAviso(mensagem, tipo) {
      const aviso = document.createElement("div");
      aviso.className = `alert ${tipo === "sucesso" ? "alert-success" : "alert-warning"} mt-3 position-fixed top-0 end-0 m-3`;
      aviso.style.zIndex = "9999";
      aviso.textContent = mensagem;
      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 4000);
    }

    function obterParametroUrl(nome) {
      const params = new URLSearchParams(window.location.search);
      return params.get(nome);
    }

    function inicializarPaginaVenda() {
      const idCliente = obterParametroUrl("idCliente");
      const nome = obterParametroUrl("nome");
      const cpf = obterParametroUrl("cpf");

      if (idCliente) {
        document.getElementById("input-idCliente").value = idCliente;
      }
      if (nome) {
        document.getElementById("input-nomeCliente").value = nome;
      }
      if (cpf) {
        document.getElementById("input-cpfCliente").value = cpf;
      }

      const inputNome = document.getElementById("input-nomeCliente");
      const inputCpf = document.getElementById("input-cpfCliente");

      inputCpf.addEventListener("blur", () => {
        selecionarCliente();
      });

      inputNome.addEventListener("blur", () => {
        const hiddenId = document.getElementById("input-idCliente").value;
        if (!hiddenId) {
          selecionarCliente();
        }
      });

      const inputDesconto = document.getElementById("input-desconto");
      inputDesconto.addEventListener("input", () => {
        atualizarTabela();
      });

      modalProduto = new bootstrap.Modal(document.getElementById("modalProduto"));
      modalServico = new bootstrap.Modal(document.getElementById("modalServico"));
    }

    document.addEventListener("DOMContentLoaded", inicializarPaginaVenda);

    function abrirModalProduto() {
      document.getElementById("mp-busca").value = "";
      document.getElementById("mp-id-produto").value = "";
      document.getElementById("mp-nome").value = "";
      document.getElementById("mp-codigo").value = "";
      document.getElementById("mp-qtd").value = 1;
      document.getElementById("mp-preco").value = "";
      document.getElementById("mp-desc").value = 0;

      modalProduto.show();
    }

    async function buscarProdutoPorNome(nomeDigitado) {
      try {
        const resp = await fetch(`${API_BASE}/api/produto`);
        if (!resp.ok) {
          throw new Error("Erro ao buscar lista de produtos.");
        }

        const lista = await resp.json();
        const nomeNormalizado = nomeDigitado.trim().toLowerCase();

        const encontrados = lista.filter(p =>
          (p.nomeProduto || "").toLowerCase().includes(nomeNormalizado)
        );

        if (encontrados.length === 0) {
          throw new Error("Nenhum produto encontrado com esse nome.");
        }

        if (encontrados.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontrados.length} produtos. Usando: "${encontrados[0].nomeProduto}".`,
            "erro"
          );
        }

        return encontrados[0];
      } catch (erro) {
        mostrarAviso(erro.message, "erro");
        console.error(erro);
        return null;
      }
    }

    async function buscarProdutoModal() {
      const nomeDigitado = document.getElementById("mp-busca").value.trim();

      if (!nomeDigitado) {
        mostrarAviso("Informe parte do nome do produto.", "erro");
        return;
      }

      const produto = await buscarProdutoPorNome(nomeDigitado);
      if (!produto) return;

      document.getElementById("mp-id-produto").value = produto.id;
      document.getElementById("mp-nome").value = produto.nomeProduto;
      document.getElementById("mp-codigo").value = produto.codigoDeBarra ?? "";
      document.getElementById("mp-preco").value = (produto.precoUnitario || 0).toFixed(2);
    }

    function confirmarProduto() {
      const id = document.getElementById("mp-id-produto").value;

      if (!id) {
        mostrarAviso("Busque e selecione um produto primeiro.", "erro");
        return;
      }

      const nome   = document.getElementById("mp-nome").value;
      const codigo = document.getElementById("mp-codigo").value;
      const qtd    = parseInt(document.getElementById("mp-qtd").value, 10) || 0;
      const preco  = parseFloat(document.getElementById("mp-preco").value) || 0;
      const desc   = parseFloat(document.getElementById("mp-desc").value) || 0;

      if (qtd <= 0) {
        mostrarAviso("Quantidade inv√°lida.", "erro");
        return;
      }

      const total = qtd * preco * (1 - desc / 100);

      produtos.push({
        id,
        nome,
        codigo,
        qtd,
        preco,
        desc,
        total
      });

      atualizarTabela();

      if (modalProduto) modalProduto.hide();

      mostrarAviso(`Produto "${nome}" adicionado √† venda.`, "sucesso");
    }

    
    function abrirModalServico() {
      document.getElementById("ms-busca").value = "";
      document.getElementById("ms-id-servico").value = "";
      document.getElementById("ms-nome").value = "";
      document.getElementById("ms-codigo").value = "";
      document.getElementById("ms-preco").value = "";
      document.getElementById("ms-desc").value = 0;

      modalServico.show();
    }

    async function buscarServicoPorNome(nomeDigitado) {
      try {
        const resp = await fetch(`${API_BASE}/api/servico`);
        if (!resp.ok) {
          throw new Error("Erro ao buscar lista de servi√ßos.");
        }

        const lista = await resp.json();
        const nomeNormalizado = nomeDigitado.trim().toLowerCase();

        const encontrados = lista.filter(s =>
          (s.nomeServico || "").toLowerCase().includes(nomeNormalizado)
        );

        if (encontrados.length === 0) {
          throw new Error("Nenhum servi√ßo encontrado com esse nome.");
        }

        if (encontrados.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontrados.length} servi√ßos. Usando: "${encontrados[0].nomeServico}".`,
            "erro"
          );
        }

        return encontrados[0];
      } catch (erro) {
        mostrarAviso(erro.message, "erro");
        console.error(erro);
        return null;
      }
    }

    async function buscarServicoModal() {
      const nomeDigitado = document.getElementById("ms-busca").value.trim();

      if (!nomeDigitado) {
        mostrarAviso("Informe parte do nome do servi√ßo.", "erro");
        return;
      }

      const servico = await buscarServicoPorNome(nomeDigitado);
      if (!servico) return;

      document.getElementById("ms-id-servico").value = servico.id;
      document.getElementById("ms-nome").value = servico.nomeServico;
      document.getElementById("ms-codigo").value = servico.codigoDoServico ?? "";
      document.getElementById("ms-preco").value =
        (servico.precoUnitario ?? servico.precoServico ?? 0).toFixed(2);
    }

    function confirmarServico() {
      const id = document.getElementById("ms-id-servico").value;

      if (!id) {
        mostrarAviso("Busque e selecione um servi√ßo primeiro.", "erro");
        return;
      }

      const nome   = document.getElementById("ms-nome").value;
      const codigo = document.getElementById("ms-codigo").value;
      const preco  = parseFloat(document.getElementById("ms-preco").value) || 0;
      const desc   = parseFloat(document.getElementById("ms-desc").value) || 0;

      const total = preco * (1 - desc / 100);

      servicos.push({
        id,
        nome,
        codigo,
        preco,
        desc,
        total
      });

      atualizarTabela();

      if (modalServico) modalServico.hide();

      mostrarAviso(`Servi√ßo "${nome}" adicionado √† venda.`, "sucesso");
    }


    function normalizarDocumento(doc) {
      return (doc || "").replace(/\D/g, "");
    }

    async function buscarListaClientes() {
      try {
        const resp = await fetch(`${API_BASE}/api/cliente`);
        if (!resp.ok) {
          throw new Error("Erro ao buscar lista de clientes.");
        }
        const lista = await resp.json();
        return Array.isArray(lista) ? lista : [];
      } catch (erro) {
        console.error(erro);
        mostrarAviso("Erro ao buscar lista de clientes.", "erro");
        return [];
      }
    }

    async function buscarClientePorNomeOuCpf(nomeDigitado, cpfDigitado) {
      const lista = await buscarListaClientes();
      if (!lista.length) {
        return null;
      }

      const cpfNormalizado = normalizarDocumento(cpfDigitado);
      const nomeNormalizado = (nomeDigitado || "").trim().toLowerCase();

      if (cpfNormalizado) {
        const encontradosPorDoc = lista.filter(c => {
          const cpf = normalizarDocumento(c.cpf);
          const cnpj = normalizarDocumento(c.cnpj);
          return cpf === cpfNormalizado || cnpj === cpfNormalizado;
        });

        if (encontradosPorDoc.length === 1) {
          return encontradosPorDoc[0];
        }
        if (encontradosPorDoc.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontradosPorDoc.length} clientes com esse documento. Usando o primeiro.`,
            "erro"
          );
          return encontradosPorDoc[0];
        }
      }

      if (nomeNormalizado) {
        const encontradosPorNome = lista.filter(c => {
          const nome = (c.nome || c.razaoSocial || "").toLowerCase();
          return nome.includes(nomeNormalizado);
        });

        if (encontradosPorNome.length === 0) {
          mostrarAviso("Nenhum cliente encontrado com esse nome.", "erro");
          return null;
        }

        if (encontradosPorNome.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontradosPorNome.length} clientes com esse nome. Usando: "${encontradosPorNome[0].nome || encontradosPorNome[0].razaoSocial}".`,
            "erro"
          );
        }

        return encontradosPorNome[0];
      }

      mostrarAviso("Digite nome ou CPF/CNPJ para buscar o cliente.", "erro");
      return null;
    }

    async function selecionarCliente() {
      const inputNome = document.getElementById("input-nomeCliente");
      const inputCpf = document.getElementById("input-cpfCliente");
      const hiddenId = document.getElementById("input-idCliente");

      const nomeDigitado = inputNome.value;
      const cpfDigitado = inputCpf.value;

      if (!nomeDigitado && !cpfDigitado) {
        mostrarAviso("Informe nome ou CPF/CNPJ para buscar o cliente.", "erro");
        return;
      }

      const cliente = await buscarClientePorNomeOuCpf(nomeDigitado, cpfDigitado);
      if (!cliente) {
        hiddenId.value = "";
        return;
      }

      const displayNome = cliente.nome || cliente.razaoSocial || "";
      const doc = cliente.cpf || cliente.cnpj || "";

      inputNome.value = displayNome;
      if (doc) inputCpf.value = doc;
      hiddenId.value = cliente.id;

      mostrarAviso(`Cliente "${displayNome}" selecionado.`, "sucesso");
    }

    function removerItem(tipo, index) {
      if (tipo === "produto") {
        produtos.splice(index, 1);
      } else {
        servicos.splice(index, 1);
      }
      atualizarTabela();
    }

    function atualizarTabela() {
      const tabelaProdutos = document.querySelector("#tabela-produtos tbody");
      const tabelaServicos = document.querySelector("#tabela-servicos tbody");

      tabelaProdutos.innerHTML = "";
      tabelaServicos.innerHTML = "";

      produtos.forEach((p, i) => {
        tabelaProdutos.innerHTML += `
          <tr>
            <td>${p.nome}</td>
            <td>${p.codigo || "-"}</td>
            <td>${p.qtd}</td>
            <td>R$ ${p.preco.toFixed(2)}</td>
            <td>${p.desc}%</td>
            <td>R$ ${p.total.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('produto', ${i})">
                Excluir
              </button>
            </td>
          </tr>`;
      });

      servicos.forEach((s, i) => {
        tabelaServicos.innerHTML += `
          <tr>
            <td>${s.nome}</td>
            <td>${s.codigo || "-"}</td>
            <td>R$ ${s.preco.toFixed(2)}</td>
            <td>${s.desc}%</td>
            <td>R$ ${s.total.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('servico', ${i})">
                Excluir
              </button>
            </td>
          </tr>`;
      });

      const subtotal =
        produtos.reduce((sum, p) => sum + p.total, 0) +
        servicos.reduce((sum, s) => sum + s.total, 0);

      const inputDesconto = document.getElementById("input-desconto");
      let descontoValor = parseFloat(inputDesconto.value) || 0;

      if (descontoValor < 0) {
        descontoValor = 0;
        inputDesconto.value = "0";
      }

      if (descontoValor > subtotal) {
        descontoValor = subtotal;
        inputDesconto.value = subtotal.toFixed(2);
      }

      const totalComDesconto = subtotal - descontoValor;
      const totalFinal = Math.max(0, totalComDesconto);

      document.getElementById("valor-total").innerText = totalFinal.toFixed(2);
    }

    async function finalizarVenda() {
      const idCliente = document.getElementById("input-idCliente").value.trim();
      const descontoGeralValor = parseFloat(document.getElementById("input-desconto").value) || 0;
      const tipoPagamento = parseInt(document.getElementById("tipo-pagamento").value, 10);
      const meioPagamento = parseInt(document.getElementById("meio-pagamento").value, 10);
      let parcelas = parseInt(document.getElementById("parcelas").value, 10) || 1;

      if (!idCliente) {
        mostrarAviso("Selecione/busque um cliente antes de finalizar a venda.", "erro");
        return;
      }

      if (produtos.length === 0 && servicos.length === 0) {
        mostrarAviso("Adicione pelo menos um produto ou servi√ßo √† venda.", "erro");
        return;
      }

      if (tipoPagamento === 0) {
        parcelas = 1;
        document.getElementById("parcelas").value = 1;
      }

      if (parcelas <= 0) {
        mostrarAviso("A quantidade de parcelas deve ser pelo menos 1.", "erro");
        return;
      }

      const itensVenda = produtos.map(p => ({
        idProduto: p.id,
        quantidade: p.qtd,
        descontoUnitario: p.desc || 0
      }));

      const servicosVenda = servicos.map(s => ({
        idServico: s.id,
        descontoServico: s.desc || 0
      }));

      const vendaDto = {
        IdCliente: idCliente,
        DescontoSobreTotalVenda: descontoGeralValor,
        ItensVenda: itensVenda,
        ServicosVenda: servicosVenda
      };

      const transacaoDto = {
        TipoPagamento: tipoPagamento,
        MeioPagamento: meioPagamento,
        QuantidadeDeParcelas: parcelas
      };

      const payload = {
        Venda: vendaDto,
        Transacao: transacaoDto
      };

      console.log("JSON que est√° indo pro backend:");
      console.log(JSON.stringify(payload, null, 2));

      try {
        const resp = await fetch(`${API_BASE}/api/venda`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const textoResposta = await resp.text();

        if (!resp.ok) {
          let msgErro = "Erro ao registrar venda.";
          try {
            const json = JSON.parse(textoResposta);
            if (Array.isArray(json)) {
              msgErro = json.join(" | ");
            } else if (typeof json === "string") {
              msgErro = json;
            }
          } catch (e) {
            if (textoResposta) msgErro = textoResposta;
          }
          throw new Error(msgErro);
        }

        let vendaCriada = null;
        try {
          vendaCriada = JSON.parse(textoResposta);
        } catch (e) {}

        mostrarAviso("Venda registrada com sucesso!", "sucesso");
        console.log("Venda criada:", vendaCriada);

        produtos = [];
        servicos = [];
        atualizarTabela();
        document.getElementById("input-desconto").value = 0;
      } catch (erro) {
        console.error("Erro ao finalizar venda:", erro);
        mostrarAviso(erro.message, "erro");
      }
    }
  </script>
</body>
</html>
