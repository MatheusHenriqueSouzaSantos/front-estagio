<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="home.html">Home</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">Menu</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_servi√ßos.html">Servi√ßos</a></li>
              <li><a class="dropdown-item active" href="buscar_vendas.html">Vendas</a></li>
              <li><a class="dropdown-item" href="relatorios.html">Relat√≥rios</a></li>
            </ul>
          </li>
        </ul>
      </div>
      <img class="img-logo" src="./resources/ImagemLogoEmpresaParaEstagio.png" alt="">
    </div>
  </nav>

  <div class="container-fluid mt-4 px-5">
    <h2 class="text-center mb-4">Nova Venda</h2>

    <form id="form-venda" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-4 position-relative">
          <label class="form-label">Nome/Raz√£o Social do Cliente:</label>
          <input type="text" id="input-nomeCliente" class="form-control" placeholder="Digite o nome/ Raz√£o Social da venda ">
          <ul id="listaDeNomesBuscados"
              class="autocomplete-list"
              style="display: none; position: absolute; z-index: 1000;"></ul>
        </div>
        
        <div class="col-md-3">
          <label class="form-label">CPF/CNPJ do Cliente:</label>
          <input type="text" id="input-cpfCliente" class="form-control" disabled>
          <div class="form-text"></div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Desconto Geral (R$):</label>
          <input
            type="number"
            id="input-desconto"
            class="form-control"
            value="0"
            min="0"
            step="0.01">
        </div>

        <div class="col-md-3 text-end">
          <button type="button" class="btn btn-success w-100" onclick="finalizarVenda()">
             üíæ Finalizar Venda
          </button>
        </div>
      </div>

      <input type="hidden" id="input-idCliente" value="">
    </form>

    <hr>

    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Produtos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalProduto()">+ Adicionar Produto</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-produtos">
        <thead class="table-secondary">
          <tr>
            <th>Produto</th>
            <th>C√≥digo de Barra</th>
            <th>Qtd</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Servi√ßos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalServico()">+ Adicionar Servi√ßo</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-servicos">
        <thead class="table-secondary">
          <tr>
            <th>Servi√ßo</th>
            <th>C√≥digo</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-venda mb-4">
      <h5>Transa√ß√£o / Pagamento</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Tipo de Pagamento:</label>
          <select id="tipo-pagamento" class="form-select">
            <option value="AVista">√Ä Vista</option>
            <option value="APrazo">A Prazo</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Meio de Pagamento:</label>
          <select id="meio-pagamento" class="form-select">
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoDebito">Cart√£o de D√©bito</option>
            <option value="CartaoCredito">Cart√£o de Cr√©dito</option>
            <option value="Pix">Pix</option>
            <option value="Boleto">Boleto</option>
            <option value="TransferenciaBancaria">Transfer√™ncia Banc√°ria</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Parcelas:</label>
          <input type="number" id="parcelas" class="form-control" value="1" min="1">
        </div>
      </div>
    </div>

    <hr>
    <div class="text-end">
      <h4>Total da Venda: R$ <span id="valor-total">0.00</span></h4>
    </div>
  </div>

  <div class="modal fade" id="modalProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5 class="mb-3">Adicionar Produto</h5>

        <div class="mb-2 position-relative">
          <label class="form-label">Nome do Produto</label>
          <div class="input-group">
            <input type="text" id="mp-busca" class="form-control" placeholder="Digite parte do nome">
          </div>
          <ul id="lista-produtos-buscados"
              class="autocomplete-list"
              style="display:none; position:absolute; z-index:1000;"></ul>
        </div>

        <input type="hidden" id="mp-id-produto">

        <div class="mb-2">
          <label class="form-label">Nome</label>
          <input type="text" id="mp-nome" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">C√≥digo</label>
          <input type="text" id="mp-codigo" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Quantidade</label>
          <input type="number" id="mp-qtd" class="form-control" value="1" min="1">
        </div>

        <div class="mb-2">
          <label class="form-label">Pre√ßo Unit√°rio (R$)</label>
          <input type="number" id="mp-preco" class="form-control" min="0" step="0.01" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Desconto Unit√°rio (%)</label>
          <input type="number" id="mp-desc" class="form-control" min="0" value="0">
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-sm" onclick="confirmarProduto()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalServico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5 class="mb-3">Adicionar Servi√ßo</h5>

        <div class="mb-2 position-relative">
          <label class="form-label">Nome do Servi√ßo</label>
          <div class="input-group">
            <input type="text" id="ms-busca" class="form-control" placeholder="Digite parte do nome">
          </div>
          <ul id="lista-servicos-buscados"
              class="autocomplete-list"
              style="display:none; position:absolute; z-index:1000;"></ul>
        </div>

        <input type="hidden" id="ms-id-servico">

        <div class="mb-2">
          <label class="form-label">Nome</label>
          <input type="text" id="ms-nome" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">C√≥digo</label>
          <input type="text" id="ms-codigo" class="form-control" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Pre√ßo (R$)</label>
          <input type="number" id="ms-preco" class="form-control" min="0" step="0.01" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Desconto (%)</label>
          <input type="number" id="ms-desc" class="form-control" min="0" value="0">
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-sm" onclick="confirmarServico()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  
  <div class="div-aviso"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
      <script>
      const API_BASE = "https://localhost:7036";

      let produtos = [];
      let servicos = [];
      let modalProduto;
      let modalServico;
      let idCliente;

      
      function mostrarAviso(mensagem, tipo) {
        
        let div = document.getElementById("div-aviso");

        if (!div) {
          div = document.createElement("div");
          div.id = "div-aviso";
          div.className = "div-aviso";
          document.body.appendChild(div);
        }

        div.className = "div-aviso";
        if (tipo === "sucesso") div.classList.add("sucesso");
        else div.classList.add("erro");

        div.textContent = mensagem;

        void div.offsetWidth;
        div.classList.add("div-aviso-subir");

        setTimeout(() => {
          div.classList.remove("div-aviso-subir");
        }, 4000);
      }

      function obterParametroUrl(nome) {
        const params = new URLSearchParams(window.location.search);
        return params.get(nome);
      }

      function inicializarPaginaVenda() {
        const inputDesconto = document.getElementById("input-desconto");
        inputDesconto.addEventListener("input", atualizarTabela);

        modalProduto = new bootstrap.Modal(document.getElementById("modalProduto"));
        modalServico = new bootstrap.Modal(document.getElementById("modalServico"));

        const selectTipoPagamento = document.getElementById("tipo-pagamento");
        const inputParcelas = document.getElementById("parcelas");

        function atualizarCampoParcelas() {
          if (selectTipoPagamento.value === "AVista") {
            inputParcelas.value = 1;
            inputParcelas.disabled = true;
          } else {
            inputParcelas.disabled = false;
          }
        }

        selectTipoPagamento.addEventListener("change", atualizarCampoParcelas);
        atualizarCampoParcelas();
      }

    
      function debounce(func, delay) {
        let timeout = null;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), delay);
        }
      }

      
      const inputNome = document.getElementById("input-nomeCliente");
      let lista = document.getElementById("listaDeNomesBuscados");

      async function BuscarListaQueContemNomeDigitado(nome) {
        const inputCpf = document.getElementById("input-cpfCliente");
        if (!nome) {
          lista.style.display = "none";
          lista.innerHTML = "";
          inputCpf.value = "";
          return;
        }
        try {
          const resposta = await fetch(API_BASE + "/api/cliente/buscar-clientes-por-nome/" + nome);
          const dados = await resposta.json();

          if (!Array.isArray(dados) || dados.length === 0) {
            const li = document.createElement("li");
            lista.style.display = "block";
            li.innerHTML = "Nenhum Registro Encontrado <br>";
            li.classList.add("li-de-clientes");
            lista.appendChild(li);
            return;
          }

          lista.innerHTML = "";

          dados.forEach(cliente => {
            const li = document.createElement("li");
            let nomeOuRazaoSocial;
            let cpfOuCnpj;
            if (cliente.tipoCliente === "PessoaFisica") {
              nomeOuRazaoSocial = cliente.nome;
              cpfOuCnpj = cliente.cpf;
            } else if (cliente.tipoCliente === "PessoaJuridica") {
              nomeOuRazaoSocial = cliente.razaoSocial;
              cpfOuCnpj = cliente.cnpj;
            } else {
              alert("Tipo de cliente inv√°lido.");
              return;
            }
            lista.style.display = "block";
            li.innerHTML = nomeOuRazaoSocial + "<br>" + cpfOuCnpj;
            li.classList.add("li-de-clientes");
            li.addEventListener("click", () => {
              idCliente = cliente.id;
              lista.innerHTML = "";
              inputNome.value = nomeOuRazaoSocial;
              inputCpf.value = cpfOuCnpj;
              lista.style.display = "none";
            });
            lista.appendChild(li);
          });
        }
        catch (erro) {
          mostrarAviso("Erro ao buscar Cliente", "erro");
        }
      }

      inputNome.addEventListener("input", debounce(() => {
        BuscarListaQueContemNomeDigitado(inputNome.value)
      }, 50));

      inputNome.addEventListener("blur", () => {
        setTimeout(() => {
          let lista = document.getElementById("listaDeNomesBuscados");
          lista.innerHTML = "";
          lista.style.display = "none";
        }, 230)
      });

      inputNome.addEventListener("focus", () => {
        if (inputNome.value != "") {
          const func = debounce(() => { BuscarListaQueContemNomeDigitado(inputNome.value) }, 50)
          func();
        }
      });

      inputNome.addEventListener("keydown", (event) => {
        const inputCpf = document.getElementById("input-cpfCliente");
        if (event.key === "Backspace" && idCliente != null) {
          inputCpf.value = "";
          idCliente = null;
        }
      });

      document.addEventListener("DOMContentLoaded", inicializarPaginaVenda);

      
      function abrirModalProduto() {
        document.getElementById("mp-busca").value = "";
        document.getElementById("mp-id-produto").value = "";
        document.getElementById("mp-nome").value = "";
        document.getElementById("mp-codigo").value = "";
        document.getElementById("mp-qtd").value = 1;
        document.getElementById("mp-preco").value = "";
        document.getElementById("mp-desc").value = 0;

        modalProduto.show();
      }

      const inputBuscaProduto = document.getElementById("mp-busca");
      const listaProdutosBuscados = document.getElementById("lista-produtos-buscados");

      async function buscarProdutosDigitando(nome) {
        if (!nome) {
          listaProdutosBuscados.style.display = "none";
          listaProdutosBuscados.innerHTML = "";
          return;
        }

        try {
          const resp = await fetch(`${API_BASE}/api/produto`);
          if (!resp.ok) {
            throw new Error("Erro ao buscar produtos.");
          }

          const dados = await resp.json();
          listaProdutosBuscados.innerHTML = "";

          const termo = nome.trim().toLowerCase();

          const produtosFiltrados = (Array.isArray(dados) ? dados : []).filter(p => {
            const n = (p.nomeProduto || "").toLowerCase();
            const cod = (p.codigoDeBarra || "").toLowerCase();
            return n.includes(termo) || cod.includes(termo);
          });

          if (produtosFiltrados.length === 0) {
            const li = document.createElement("li");
            li.innerHTML = "Nenhum produto encontrado";
            li.classList.add("li-de-clientes");
            listaProdutosBuscados.appendChild(li);
            listaProdutosBuscados.style.display = "block";
            return;
          }

          produtosFiltrados.forEach(produto => {
            const li = document.createElement("li");
            li.classList.add("li-de-clientes");
            li.innerHTML = `${produto.nomeProduto}<br>${produto.codigoDeBarra || ""}`;

            li.addEventListener("click", () => {
              document.getElementById("mp-id-produto").value = produto.id;
              document.getElementById("mp-nome").value = produto.nomeProduto;
              document.getElementById("mp-codigo").value = produto.codigoDeBarra || "";
              document.getElementById("mp-preco").value = (produto.precoUnitario || 0).toFixed(2);

              listaProdutosBuscados.innerHTML = "";
              listaProdutosBuscados.style.display = "none";
              inputBuscaProduto.value = produto.nomeProduto;
            });

            listaProdutosBuscados.appendChild(li);
          });

          listaProdutosBuscados.style.display = "block";
        } catch (erro) {
          console.error(erro);
          mostrarAviso("Erro ao buscar produtos.", "erro");
        }
      }

      inputBuscaProduto.addEventListener(
        "input",
        debounce(() => buscarProdutosDigitando(inputBuscaProduto.value), 200)
      );

      inputBuscaProduto.addEventListener("blur", () => {
        setTimeout(() => {
          listaProdutosBuscados.innerHTML = "";
          listaProdutosBuscados.style.display = "none";
        }, 200);
      });

      inputBuscaProduto.addEventListener("focus", () => {
        if (inputBuscaProduto.value) {
          const func = debounce(() => buscarProdutosDigitando(inputBuscaProduto.value), 200);
          func();
        }
      });

      
      function confirmarProduto() {
        const id = document.getElementById("mp-id-produto").value;

        if (!id) {
          mostrarAviso("Busque e selecione um produto primeiro.", "erro");
          return;
        }

        const nome   = document.getElementById("mp-nome").value;
        const codigo = document.getElementById("mp-codigo").value;
        const qtd    = parseInt(document.getElementById("mp-qtd").value, 10) || 0;
        const preco  = parseFloat((document.getElementById("mp-preco").value || "").replace(",", ".")) || 0;
        const desc   = parseFloat((document.getElementById("mp-desc").value || "").replace(",", ".")) || 0;

        if (qtd <= 0) {
          mostrarAviso("Quantidade inv√°lida.", "erro");
          return;
        }

        const total = qtd * preco * (1 - desc / 100);

        produtos.push({ id, nome, codigo, qtd, preco, desc, total });

        atualizarTabela();
        modalProduto.hide();
      }

      
      function abrirModalServico() {
        document.getElementById("ms-busca").value = "";
        document.getElementById("ms-id-servico").value = "";
        document.getElementById("ms-nome").value = "";
        document.getElementById("ms-codigo").value = "";
        document.getElementById("ms-preco").value = "";
        document.getElementById("ms-desc").value = 0;

        modalServico.show();
      }

      const inputBuscaServico = document.getElementById("ms-busca");
      const listaServicosBuscados = document.getElementById("lista-servicos-buscados");

      async function buscarServicosDigitando(nome) {
        if (!nome) {
          listaServicosBuscados.style.display = "none";
          listaServicosBuscados.innerHTML = "";
          return;
        }

        try {
          const resp = await fetch(`${API_BASE}/api/servico`);
          if (!resp.ok) {
            throw new Error("Erro ao buscar servi√ßos.");
          }

          const dados = await resp.json();
          listaServicosBuscados.innerHTML = "";

          const termo = nome.trim().toLowerCase();

          const servicosFiltrados = (Array.isArray(dados) ? dados : []).filter(s => {
            const n = (s.nomeServico || "").toLowerCase();
            const cod = (s.codigoDoServico || "").toLowerCase();
            return n.includes(termo) || cod.includes(termo);
          });

          if (servicosFiltrados.length === 0) {
            const li = document.createElement("li");
            li.innerHTML = "Nenhum servi√ßo encontrado";
            li.classList.add("li-de-clientes");
            listaServicosBuscados.appendChild(li);
            listaServicosBuscados.style.display = "block";
            return;
          }

          servicosFiltrados.forEach(servico => {
            const li = document.createElement("li");
            li.classList.add("li-de-clientes");
            li.innerHTML = `${servico.nomeServico}<br>${servico.codigoDoServico || ""}`;

            li.addEventListener("click", () => {
              document.getElementById("ms-id-servico").value = servico.id;
              document.getElementById("ms-nome").value = servico.nomeServico;
              document.getElementById("ms-codigo").value = servico.codigoDoServico || "";
              document.getElementById("ms-preco").value =
                (servico.precoUnitario ?? servico.precoServico ?? 0).toFixed(2);

              listaServicosBuscados.innerHTML = "";
              listaServicosBuscados.style.display = "none";
              inputBuscaServico.value = servico.nomeServico;
            });

            listaServicosBuscados.appendChild(li);
          });

          listaServicosBuscados.style.display = "block";
        } catch (erro) {
          console.error(erro);
          mostrarAviso("Erro ao buscar servi√ßos.", "erro");
        }
      }

      inputBuscaServico.addEventListener(
        "input",
        debounce(() => buscarServicosDigitando(inputBuscaServico.value), 200)
      );

      inputBuscaServico.addEventListener("blur", () => {
        setTimeout(() => {
          listaServicosBuscados.innerHTML = "";
          listaServicosBuscados.style.display = "none";
        }, 200);
      });

      inputBuscaServico.addEventListener("focus", () => {
        if (inputBuscaServico.value) {
          const func = debounce(() => buscarServicosDigitando(inputBuscaServico.value), 200);
          func();
        }
      });

      
      function confirmarServico() {
        const id = document.getElementById("ms-id-servico").value;

        if (!id) {
          mostrarAviso("Busque e selecione um servi√ßo primeiro.", "erro");
          return;
        }

        const nome   = document.getElementById("ms-nome").value;
        const codigo = document.getElementById("ms-codigo").value;
        const preco  = parseFloat((document.getElementById("ms-preco").value || "").replace(",", ".")) || 0;
        const desc   = parseFloat((document.getElementById("ms-desc").value || "").replace(",", ".")) || 0;

        const total = preco * (1 - desc / 100);

        servicos.push({ id, nome, codigo, preco, desc, total });

        atualizarTabela();
        modalServico.hide();
      }

      
      function removerItem(tipo, index) {
        if (tipo === "produto") {
          produtos.splice(index, 1);
        } else {
          servicos.splice(index, 1);
        }
        atualizarTabela();
      }

      function atualizarTabela() {
        const tabelaProdutos = document.querySelector("#tabela-produtos tbody");
        const tabelaServicos = document.querySelector("#tabela-servicos tbody");

        tabelaProdutos.innerHTML = "";
        tabelaServicos.innerHTML = "";

        produtos.forEach((p, i) => {
          tabelaProdutos.innerHTML += `
            <tr>
              <td>${p.nome}</td>
              <td>${p.codigo || "-"}</td>
              <td>${p.qtd}</td>
              <td>R$ ${p.preco.toFixed(2)}</td>
              <td>${p.desc}%</td>
              <td>R$ ${p.total.toFixed(2)}</td>
              <td>
                <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('produto', ${i})">
                  Excluir
                </button>
              </td>
            </tr>`;
        });

        servicos.forEach((s, i) => {
          tabelaServicos.innerHTML += `
            <tr>
              <td>${s.nome}</td>
              <td>${s.codigo || "-"}</td>
              <td>R$ ${s.preco.toFixed(2)}</td>
              <td>${s.desc}%</td>
              <td>R$ ${s.total.toFixed(2)}</td>
              <td>
                <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('servico', ${i})">
                  Excluir
                </button>
              </td>
            </tr>`;
        });

        const subtotal =
          produtos.reduce((sum, p) => sum + p.total, 0) +
          servicos.reduce((sum, s) => sum + s.total, 0);

        const inputDesconto = document.getElementById("input-desconto");
        let descontoValor = parseFloat(inputDesconto.value) || 0;

        if (descontoValor < 0) {
          descontoValor = 0;
          inputDesconto.value = "0";
        }

        if (descontoValor > subtotal) {
          descontoValor = subtotal;
          inputDesconto.value = subtotal.toFixed(2);
        }

        const totalComDesconto = subtotal - descontoValor;
        const totalFinal = Math.max(0, totalComDesconto);

        document.getElementById("valor-total").innerText = totalFinal.toFixed(2);
      }

      async function finalizarVenda() {
        const descontoGeralValor = parseFloat(document.getElementById("input-desconto").value) || 0;
        const tipoPagamento = document.getElementById("tipo-pagamento").value;
        const meioPagamento = document.getElementById("meio-pagamento").value;
        let parcelas = parseInt(document.getElementById("parcelas").value, 10) || 1;

        if (!idCliente) {
          mostrarAviso("Selecione/busque um cliente antes de finalizar a venda.", "erro");
          return;
        }

        if (produtos.length === 0 && servicos.length === 0) {
          mostrarAviso("Adicione pelo menos um produto ou servi√ßo √† venda.", "erro");
          return;
        }

        if (tipoPagamento === "AVista") {
          parcelas = 1;
          const inputParcelas = document.getElementById("parcelas");
          inputParcelas.value = 1;
          inputParcelas.disabled = true;
        }

        if (parcelas <= 0) {
          mostrarAviso("A quantidade de parcelas deve ser pelo menos 1.", "erro");
          return;
        }

        const itensVenda = produtos.map(p => ({
          idProduto: p.id,
          quantidade: p.qtd,
          descontoUnitario: p.desc || 0
        }));

        const servicosVenda = servicos.map(s => ({
          idServico: s.id,
          descontoServico: s.desc || 0
        }));

        const vendaDto = {
          IdCliente: idCliente,
          DescontoSobreTotalVenda: descontoGeralValor,
          ItensVenda: itensVenda,
          ServicosVenda: servicosVenda
        };

        const transacaoDto = {
          TipoPagamento: tipoPagamento,
          MeioPagamento: meioPagamento,
          QuantidadeDeParcelas: parcelas
        };

        const payload = {
          Venda: vendaDto,
          Transacao: transacaoDto
        };

        console.log("JSON que est√° indo pro backend:");
        console.log(JSON.stringify(payload, null, 2));

        try {
          const resp = await fetch(`${API_BASE}/api/venda`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const textoResposta = await resp.text();

          if (!resp.ok) {
            let msgErro = "Erro ao registrar venda.";
            try {
              const json = JSON.parse(textoResposta);
              if (Array.isArray(json)) {
                msgErro = json.join(" | ");
              } else if (typeof json === "string") {
                msgErro = json;
              }
            } catch (e) {
              if (textoResposta) msgErro = textoResposta;
            }
            throw new Error(msgErro);
          }

          let vendaCriada = null;
          try {
            vendaCriada = JSON.parse(textoResposta);
          } catch (e) {}

          mostrarAviso("Venda registrada", "sucesso");
          console.log("Venda criada:", vendaCriada);

          produtos = [];
          servicos = [];
          atualizarTabela();
          document.getElementById("input-desconto").value = 0;

          setTimeout(() => {
            window.location.href = "./buscar_vendas.html";
          }, 1900);

        } catch (erro) {
          console.error("Erro ao finalizar venda:", erro);
          mostrarAviso(erro.message, "erro");
        }
      }
    </script>

</body>
</html>
