<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  
  
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">Home</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">Menu</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_servi√ßos.html">Servi√ßos</a></li>
              <li><a class="dropdown-item active" href="vendas.html">Vendas</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4 px-5">
    <h2 class="text-center mb-4">Nova Venda</h2>

    
    <form id="form-venda" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Nome do Cliente:</label>
          <input type="text" id="input-nomeCliente" class="form-control" placeholder="Digite o nome do cliente">
        </div>

        <div class="col-md-3">
          <label class="form-label">CPF do Cliente (opcional):</label>
          <input type="text" id="input-cpfCliente" class="form-control" placeholder="000.000.000-00">
          <div class="form-text"></div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Desconto Geral (%):</label>
          <input type="number" id="input-desconto" class="form-control" value="0" min="0" max="100">
        </div>

        <div class="col-md-3 text-end">
          <button type="button" class="btn btn-success w-100" onclick="finalizarVenda()">
             üíæ Finalizar Venda
          </button>

        </div>
      </div>

      
      <input type="hidden" id="input-idCliente" value="">
    </form>

    <hr>

    
    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Produtos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalProduto()">+ Adicionar Produto</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-produtos">
        <thead class="table-secondary">
          <tr>
            <th>Produto</th>
            <th>C√≥digo de Barra</th>
            <th>Qtd</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

   
    <div class="section-venda mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Servi√ßos</h5>
        <button class="btn btn-primary btn-sm" type="button" onclick="abrirModalServico()">+ Adicionar Servi√ßo</button>
      </div>
      <table class="table table-striped text-center align-middle" id="tabela-servicos">
        <thead class="table-secondary">
          <tr>
            <th>Servi√ßo</th>
            <th>C√≥digo</th>
            <th>Pre√ßo</th>
            <th>Desconto</th>
            <th>Total</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    
    <div class="section-venda mb-4">
      <h5>Transa√ß√£o / Pagamento</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Tipo de Pagamento:</label>
          <select id="tipo-pagamento" class="form-select">
            <option value="AVista">√Ä Vista</option>
            <option value="APrazo">A Prazo</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Meio de Pagamento:</label>
          <select id="meio-pagamento" class="form-select">
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoDebito">Cart√£o de D√©bito</option>
            <option value="CartaoCredito">Cart√£o de Cr√©dito</option>
            <option value="Pix">Pix</option>
            <option value="Boleto">Boleto</option>
            <option value="PagamentoBancario">Transfer√™ncia Banc√°ria</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Parcelas:</label>
          <input type="number" id="parcelas" class="form-control" value="1" min="1">
        </div>
      </div>
    </div>

    <hr>
    <div class="text-end">
      <h4>Total da Venda: R$ <span id="valor-total">0.00</span></h4>
    </div>
  </div>

  
  <div class="modal fade" id="modalProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5>Adicionar Produto</h5>
        <div class="mb-2">
          <label>Nome do Produto</label>
          <input type="text" id="codigo-produto" class="form-control" placeholder="Digite parte do nome do produto">
        </div>
        <div class="mb-2">
          <label>Quantidade</label>
          <input type="number" id="qtd-produto" class="form-control" value="1" min="1">
        </div>
        <div class="mb-2">
          <label>Pre√ßo Unit√°rio (R$)</label>
          <input type="number" id="preco-produto" class="form-control" value="0" step="0.01" disabled>
        </div>
        <div class="mb-2">
          <label>Desconto Unit√°rio (%)</label>
          <input type="number" id="desc-produto" class="form-control" value="0" min="0" max="100">
        </div>
        <div class="text-end">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
          <button class="btn btn-primary" type="button" onclick="adicionarProduto()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  
  <div class="modal fade" id="modalServico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5>Adicionar Servi√ßo</h5>
        <div class="mb-2">
          <label>Nome do Servi√ßo</label>
          <input type="text" id="codigo-servico" class="form-control" placeholder="Digite parte do nome do servi√ßo">
        </div>
        <div class="mb-2">
          <label>Pre√ßo (R$)</label>
          <input type="number" id="preco-servico" class="form-control" value="0" step="0.01" disabled>
        </div>
        <div class="mb-2">
          <label>Desconto (%)</label>
          <input type="number" id="desc-servico" class="form-control" value="0" min="0" max="100">
        </div>
        <div class="text-end">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
          <button class="btn btn-primary" type="button" onclick="adicionarServico()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "https://localhost:7036";

    let produtos = [];
    let servicos = []; 

    

    function mostrarAviso(mensagem, tipo) {
      const aviso = document.createElement("div");
      aviso.className = `alert ${tipo === "sucesso" ? "alert-success" : "alert-warning"} mt-3 position-fixed top-0 end-0 m-3`;
      aviso.style.zIndex = "9999";
      aviso.textContent = mensagem;
      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 4000);
    }

    function obterParametroUrl(nome) {
      const params = new URLSearchParams(window.location.search);
      return params.get(nome);
    }

        function inicializarPaginaVenda() {
      const idCliente = obterParametroUrl("idCliente");
      const nome = obterParametroUrl("nome");
      const cpf = obterParametroUrl("cpf");

      if (idCliente) {
        document.getElementById("input-idCliente").value = idCliente;
      }
      if (nome) {
        document.getElementById("input-nomeCliente").value = nome;
      }
      if (cpf) {
        document.getElementById("input-cpfCliente").value = cpf;
      }

      
      const inputNome = document.getElementById("input-nomeCliente");
      const inputCpf = document.getElementById("input-cpfCliente");

      
      inputCpf.addEventListener("blur", () => {
        selecionarCliente();
      });

     
      inputNome.addEventListener("blur", () => {
        const hiddenId = document.getElementById("input-idCliente").value;
        if (!hiddenId) {
          selecionarCliente();
        }
      });

          const inputDesconto = document.getElementById("input-desconto");
    inputDesconto.addEventListener("input", () => {
      atualizarTabela();
    });

      
    }

  

    document.addEventListener("DOMContentLoaded", inicializarPaginaVenda);

    

    function abrirModalProduto() {
      document.getElementById("codigo-produto").value = "";
      document.getElementById("qtd-produto").value = 1;
      document.getElementById("preco-produto").value = 0;
      document.getElementById("desc-produto").value = 0;
      new bootstrap.Modal(document.getElementById("modalProduto")).show();
    }

    function abrirModalServico() {
      document.getElementById("codigo-servico").value = "";
      document.getElementById("preco-servico").value = 0;
      document.getElementById("desc-servico").value = 0;
      new bootstrap.Modal(document.getElementById("modalServico")).show();
    }

    // BUSCA PRODUTO POR NOME 
     GET = "https://localhost:7036/api/produto" 
    async function buscarProdutoPorNome(nomeDigitado) {
      try {
        const resp = await fetch(`${API_BASE}/api/produto`);
        if (!resp.ok) {
          throw new Error("Erro ao buscar lista de produtos.");
        }

        const lista = await resp.json();
        const nomeNormalizado = nomeDigitado.trim().toLowerCase();

        const encontrados = lista.filter(p =>
          (p.nomeProduto || "").toLowerCase().includes(nomeNormalizado)
        );

        if (encontrados.length === 0) {
          throw new Error("Nenhum produto encontrado com esse nome.");
        }

        if (encontrados.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontrados.length} produtos. Usando: "${encontrados[0].nomeProduto}".`,
            "erro"
          );
        }

        return encontrados[0]; // devolve s√≥ um produto
      } catch (erro) {
        mostrarAviso(erro.message, "erro");
        console.error(erro);
        return null;
      }
    }

    // ADICIONAR PRODUTO 
    async function adicionarProduto() {
      const nomeDigitado = document.getElementById("codigo-produto").value.trim();
      const qtd = parseInt(document.getElementById("qtd-produto").value, 10);
      const desc = parseFloat(document.getElementById("desc-produto").value) || 0;

      if (!nomeDigitado) {
        mostrarAviso("Informe o nome do produto.", "erro");
        return;
      }
      if (!qtd || qtd <= 0) {
        mostrarAviso("Quantidade inv√°lida.", "erro");
        return;
      }

      const produto = await buscarProdutoPorNome(nomeDigitado);
      if (!produto) return;

      const preco = parseFloat(produto.precoUnitario || 0);
      const total = qtd * preco * (1 - desc / 100);

      produtos.push({
        id: produto.id,
        nome: produto.nomeProduto,
        codigo: produto.codigoDeBarra,
        qtd,
        preco,
        desc,
        total
      });

      atualizarTabela();

      const modal = bootstrap.Modal.getInstance(document.getElementById("modalProduto"));
      if (modal) modal.hide();

      mostrarAviso(`Produto "${produto.nomeProduto}" adicionado √† venda.`, "sucesso");
    }

    //  BUSCA SERVI√áO POR NOME 

GET = "https://localhost:7036/api/servico" 
async function buscarServicoPorNome(nomeDigitado) {
  try {
    const resp = await fetch(`${API_BASE}/api/servico`);
    if (!resp.ok) {
      throw new Error("Erro ao buscar lista de servi√ßos.");
    }

    const lista = await resp.json();
    const nomeNormalizado = nomeDigitado.trim().toLowerCase();

    const encontrados = lista.filter(s =>
      (s.nomeServico || "").toLowerCase().includes(nomeNormalizado)
    );

    if (encontrados.length === 0) {
      throw new Error("Nenhum servi√ßo encontrado com esse nome.");
    }

    if (encontrados.length > 1) {
      mostrarAviso(
        `Foram encontrados ${encontrados.length} servi√ßos. Usando: "${encontrados[0].nomeServico}".`,
        "erro"
      );
    }

    return encontrados[0];
  } catch (erro) {
    mostrarAviso(erro.message, "erro");
    console.error(erro);
    return null;
  }
}

//  ADICIONAR SERVI√áO 

async function adicionarServico() {
  const nomeDigitado = document.getElementById("codigo-servico").value.trim();
  const desc = parseFloat(document.getElementById("desc-servico").value) || 0;

  if (!nomeDigitado) {
    mostrarAviso("Informe o nome do servi√ßo.", "erro");
    return;
  }

  const servico = await buscarServicoPorNome(nomeDigitado);
  if (!servico) return;

 
  const preco = parseFloat(servico.precoServico || 0);

  const total = preco * (1 - desc / 100);

  servicos.push({
    id: servico.id,
    nome: servico.nomeServico,
    codigo: servico.codigoDoServico,
    preco,
    desc,
    total
  });

  atualizarTabela();

  const modal = bootstrap.Modal.getInstance(document.getElementById("modalServico"));
  if (modal) modal.hide();

  mostrarAviso(`Servi√ßo "${servico.nomeServico}" adicionado √† venda.`, "sucesso");
}

    

    function normalizarDocumento(doc) {
      return (doc || "").replace(/\D/g, "");
    }

    
    async function buscarListaClientes() {
      try {
        const resp = await fetch(`${API_BASE}/api/cliente`);
        if (!resp.ok) {
          throw new Error("Erro ao buscar lista de clientes.");
        }
        const lista = await resp.json();
        return Array.isArray(lista) ? lista : [];
      } catch (erro) {
        console.error(erro);
        mostrarAviso("Erro ao buscar lista de clientes.", "erro");
        return [];
      }
    }

    
    async function buscarClientePorNomeOuCpf(nomeDigitado, cpfDigitado) {
      const lista = await buscarListaClientes();
      if (!lista.length) {
        return null;
      }

      const cpfNormalizado = normalizarDocumento(cpfDigitado);
      const nomeNormalizado = (nomeDigitado || "").trim().toLowerCase();

      
      if (cpfNormalizado) {
        const encontradosPorDoc = lista.filter(c => {
          const cpf = normalizarDocumento(c.cpf);
          const cnpj = normalizarDocumento(c.cnpj);
          return cpf === cpfNormalizado || cnpj === cpfNormalizado;
        });

        if (encontradosPorDoc.length === 1) {
          return encontradosPorDoc[0];
        }
        if (encontradosPorDoc.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontradosPorDoc.length} clientes com esse documento. Usando o primeiro.`,
            "erro"
          );
          return encontradosPorDoc[0];
        }
      }

      
      if (nomeNormalizado) {
        const encontradosPorNome = lista.filter(c => {
          const nome = (c.nome || c.razaoSocial || "").toLowerCase();
          return nome.includes(nomeNormalizado);
        });

        if (encontradosPorNome.length === 0) {
          mostrarAviso("Nenhum cliente encontrado com esse nome.", "erro");
          return null;
        }

        if (encontradosPorNome.length > 1) {
          mostrarAviso(
            `Foram encontrados ${encontradosPorNome.length} clientes com esse nome. Usando: "${encontradosPorNome[0].nome || encontradosPorNome[0].razaoSocial}".`,
            "erro"
          );
        }

        return encontradosPorNome[0];
      }

      mostrarAviso("Digite nome ou CPF/CNPJ para buscar o cliente.", "erro");
      return null;
    }

    
    async function selecionarCliente() {
      const inputNome = document.getElementById("input-nomeCliente");
      const inputCpf = document.getElementById("input-cpfCliente");
      const hiddenId = document.getElementById("input-idCliente");

      const nomeDigitado = inputNome.value;
      const cpfDigitado = inputCpf.value;

      if (!nomeDigitado && !cpfDigitado) {
        mostrarAviso("Informe nome ou CPF/CNPJ para buscar o cliente.", "erro");
        return;
      }

      const cliente = await buscarClientePorNomeOuCpf(nomeDigitado, cpfDigitado);
      if (!cliente) {
        hiddenId.value = "";
        return;
      }

      const displayNome = cliente.nome || cliente.razaoSocial || "";
      const doc = cliente.cpf || cliente.cnpj || "";

      inputNome.value = displayNome;
      if (doc) inputCpf.value = doc;
      hiddenId.value = cliente.id;

      mostrarAviso(`Cliente "${displayNome}" selecionado.`, "sucesso");
    }


    

    

    function removerItem(tipo, index) {
      if (tipo === "produto") {
        produtos.splice(index, 1);
      } else {
        servicos.splice(index, 1);
      }
      atualizarTabela();
    }

    
    function atualizarTabela() {
  const tabelaProdutos = document.querySelector("#tabela-produtos tbody");
  const tabelaServicos = document.querySelector("#tabela-servicos tbody");

  tabelaProdutos.innerHTML = "";
  tabelaServicos.innerHTML = "";

  produtos.forEach((p, i) => {
    tabelaProdutos.innerHTML += `
      <tr>
        <td>${p.nome}</td>
        <td>${p.codigo || "-"}</td>
        <td>${p.qtd}</td>
        <td>R$ ${p.preco.toFixed(2)}</td>
        <td>${p.desc}%</td>
        <td>R$ ${p.total.toFixed(2)}</td>
        <td>
          <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('produto', ${i})">
            Excluir
          </button>
        </td>
      </tr>`;
  });

  servicos.forEach((s, i) => {
    tabelaServicos.innerHTML += `
      <tr>
        <td>${s.nome}</td>
        <td>${s.codigo || "-"}</td>
        <td>R$ ${s.preco.toFixed(2)}</td>
        <td>${s.desc}%</td>
        <td>R$ ${s.total.toFixed(2)}</td>
        <td>
          <button class="btn btn-danger btn-sm" type="button" onclick="removerItem('servico', ${i})">
            Excluir
          </button>
        </td>
      </tr>`;
  });

  
  const subtotal =
    produtos.reduce((sum, p) => sum + p.total, 0) +
    servicos.reduce((sum, s) => sum + s.total, 0);

  
  const inputDesconto = document.getElementById("input-desconto");
  const descontoPercent = parseFloat(inputDesconto.value) || 0;

  
  const descontoAjustado = Math.min(Math.max(descontoPercent, 0), 100);
  if (descontoAjustado !== descontoPercent) {
    inputDesconto.value = descontoAjustado; 
  }

  const fatorDesconto = descontoAjustado / 100;
  const totalComDesconto = subtotal * (1 - fatorDesconto);

  document.getElementById("valor-total").innerText = totalComDesconto.toFixed(2);
}


    //  FINALIZAR VENDA 
    async function finalizarVenda() {
      const idCliente = document.getElementById("input-idCliente").value.trim();
      const descontoGeralPercent = parseFloat(document.getElementById("input-desconto").value) || 0;
      const tipoPagamento = document.getElementById("tipo-pagamento").value;
      const meioPagamento = document.getElementById("meio-pagamento").value;
      let parcelas = parseInt(document.getElementById("parcelas").value, 10) || 1;

      
      if (!idCliente) {
        mostrarAviso("Selecione/busque um cliente antes de finalizar a venda.", "erro");
        return;
      }

      if (produtos.length === 0 && servicos.length === 0) {
        mostrarAviso("Adicione pelo menos um produto ou servi√ßo √† venda.", "erro");
        return;
      }

      // se for √† vista, for√ßa 1 parcela
      if (tipoPagamento === "AVista") {
        parcelas = 1;
        document.getElementById("parcelas").value = 1;
      }

      if (parcelas <= 0) {
        mostrarAviso("A quantidade de parcelas deve ser pelo menos 1.", "erro");
        return;
      }

      // monta ItensVenda (ItemVendaInputDto)
      const itensVenda = produtos.map(p => ({
        idProduto: p.id,               
        quantidade: p.qtd,
        descontoUnitario: p.desc || 0  
      }));

      // monta ServicosVenda (ServicoVendaInputDto)
      const servicosVenda = servicos.map(s => ({
        idServico: s.id,
        descontoServico: s.desc || 0   
      }));

      // VendaInputDto
      const vendaDto = {
        idCliente: idCliente,
        descontoSobreTotalVenda: descontoGeralPercent, 
        itensVenda: itensVenda,
        servicosVenda: servicosVenda
      };


      // TransacaoInputDto
      const transacaoDto = {
        tipoPagamento: tipoPagamento,     
        meioPagamaneto: meioPagamento,   
        quantidadeDeParcelas: parcelas
      };

      // VendaTransacaoInputDto
      const payload = {
        venda: vendaDto,
        transacao: transacaoDto
      };

      console.log("JSON que est√° indo pro backend:");
      console.log(JSON.stringify(payload, null, 2));


      try {
        const resp = await fetch(`${API_BASE}/api/venda`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const textoResposta = await resp.text();

        if (!resp.ok) {
          let msgErro = "Erro ao registrar venda.";
          try {
            const json = JSON.parse(textoResposta);
            if (Array.isArray(json)) {
              msgErro = json.join(" | ");
            } else if (typeof json === "string") {
              msgErro = json;
            }
          } catch (e) {
            if (textoResposta) msgErro = textoResposta;
          }
          throw new Error(msgErro);
        }

        let vendaCriada = null;
        try {
          vendaCriada = JSON.parse(textoResposta); // VendaTransacaoOutputDto
        } catch (e) {
         
        }

        mostrarAviso("Venda registrada com sucesso!", "sucesso");
        console.log("Venda criada:", vendaCriada);

        
        produtos = [];
        servicos = [];
        atualizarTabela();
        // mant√©m cliente preenchido, s√≥ zera desconto geral:
        document.getElementById("input-desconto").value = 0;
      } catch (erro) {
        console.error("Erro ao finalizar venda:", erro);
        mostrarAviso(erro.message, "erro");
      }
    }



  </script>
</body>
</html>
