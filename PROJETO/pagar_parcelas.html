<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagar Parcelas da Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="home.html">Home</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle mt-1" role="button" data-bs-toggle="dropdown">
            Menu
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
            <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
            <li><a class="dropdown-item" href="buscar_servi√ßos.html">Servi√ßos</a></li>
            <li><a class="dropdown-item active" href="buscar_vendas.html">Vendas</a></li>
            <li><a class="dropdown-item" href="relatorios.html">Relat√≥rios</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Pagamento de Parcelas da Venda</h2>
    <a href="buscar_vendas.html" class="btn btn-secondary">Voltar</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5>Informa√ß√µes da Venda</h5>
      <div class="row g-2" id="info-venda"></div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5>Informa√ß√µes da Transa√ß√£o</h5>
      <div class="row g-2" id="info-transacao"></div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5>Registrar Pagamento de Parcelas</h5>
      <form class="row g-3" onsubmit="event.preventDefault(); pagarParcelas();">
        <div class="col-md-4">
          <label class="form-label">Quantidade de parcelas a marcar como pagas agora:</label>
          <input type="number" id="input-qtd-parcelas" class="form-control" min="1" value="1">
          <div class="form-text" id="texto-limite"></div>
        </div>
        <div class="col-md-3 align-self-end">
          <button type="submit" id="btn-pagar" class="btn btn-success w-100">
            Registrar Pagamento
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = "https://localhost:7036";
  const API_VENDA = API_BASE + "/api/venda";

  let vendaCarregada = null;
  let transacaoAtual = null;

  function mostrarAviso(msg, tipo) {
    const aviso = document.createElement("div");
    aviso.className = `alert ${tipo === "sucesso" ? "alert-success" : "alert-warning"} position-fixed top-0 end-0 m-3`;
    aviso.style.zIndex = "9999";
    aviso.textContent = msg;
    document.body.appendChild(aviso);
    setTimeout(() => aviso.remove(), 4000);
  }

  function obterParametroUrl(nome) {
    const params = new URLSearchParams(window.location.search);
    return params.get(nome);
  }

  function formatarData(dataIsoOuString) {
    if (!dataIsoOuString) return "‚Äî";
    const d = new Date(dataIsoOuString);
    if (isNaN(d)) return dataIsoOuString;
    return d.toLocaleString("pt-BR");
  }

  
  function preencherInfoVenda(venda) {
    const div = document.getElementById("info-venda");
    const cliente = venda.cliente || {};
    const nomeCliente = cliente.nome || cliente.razaoSocial || "‚Äî";

    const codigoVenda =
      venda.codigoDaVenda ??
      venda.codigoVenda ??
      venda.codigo ??
      venda.codigoDaVendaComMascara ??
      venda.idVenda;

    div.innerHTML = `
      <div class="col-md-3"><strong>C√≥digo da Venda:</strong> ${codigoVenda}</div>
      <div class="col-md-3"><strong>Data:</strong> ${formatarData(venda.dataCriacao)}</div>
      <div class="col-md-3"><strong>Cliente:</strong> ${nomeCliente}</div>
      <div class="col-md-3"><strong>Total com Desconto (R$):</strong> ${Number(venda.valorTotalComDesconto ?? 0).toFixed(2)}</div>
    `;
  }

 function preencherInfoTransacao(transacao) {
  const div = document.getElementById("info-transacao");
  if (!transacao) {
    div.innerHTML = `<div class="col-12 text-muted">Nenhuma transa√ß√£o encontrada para esta venda.</div>`;
    return;
  }

  const numeroDeParcelasPagas   = transacao.numeroDeParcelasPagas   ?? 0;
  const numeroDeParcelasNaoPagas = transacao.numeroDeParcelasNaoPagas ?? 0;

  let numeroDeParcelas =
    transacao.numeroDeParcelas ??
    transacao.quantidadeDeParcelas ??
    0;

  const somaCalculada = numeroDeParcelasPagas + numeroDeParcelasNaoPagas;
  if (!numeroDeParcelas || numeroDeParcelas < somaCalculada) {
    numeroDeParcelas = somaCalculada;
  }

  const situacao = transacao.pago
    ? "Paga"
    : (transacao.transacaoEmCurso ? "Em andamento" : "Em aberto");

  div.innerHTML = `
    <div class="col-md-3"><strong>ID Transa√ß√£o:</strong> ${transacao.idTransacao}</div>
    <div class="col-md-3"><strong>Data:</strong> ${formatarData(transacao.dataCriacao)}</div>
    <div class="col-md-3"><strong>Tipo Pagamento:</strong> ${transacao.tipoPagamento}</div>
    <div class="col-md-3"><strong>Meio Pagamento:</strong> ${transacao.meioPagamento}</div>
    <div class="col-md-3"><strong>Parcelas Totais:</strong> ${numeroDeParcelas}</div>
    <div class="col-md-3"><strong>Parcelas Pagas:</strong> ${numeroDeParcelasPagas}</div>
    <div class="col-md-3"><strong>Parcelas em Aberto:</strong> ${numeroDeParcelasNaoPagas}</div>
    <div class="col-md-3"><strong>Valor Pago (R$):</strong> ${Number(transacao.valorPago ?? 0).toFixed(2)}</div>
    <div class="col-md-3"><strong>Situa√ß√£o:</strong> ${situacao}</div>
  `;

  transacaoAtual = {
    ...transacao,
    numeroDeParcelas,
    numeroDeParcelasPagas,
    numeroDeParcelasNaoPagas
  };

  const inputQtd   = document.getElementById("input-qtd-parcelas");
  const textoLimite = document.getElementById("texto-limite");
  const btnPagar   = document.getElementById("btn-pagar");

  if (transacao.pago || numeroDeParcelasNaoPagas <= 0) {
    inputQtd.disabled = true;
    btnPagar.disabled = true;
    textoLimite.textContent = "Venda j√° est√° totalmente paga.";
  } else {
    inputQtd.disabled = false;
    btnPagar.disabled = false;
    inputQtd.max = numeroDeParcelasNaoPagas;
    textoLimite.textContent =
      `M√°ximo de parcelas que voc√™ pode marcar como pagas agora: ${numeroDeParcelasNaoPagas}.`;
  }
}

  async function carregarVenda() {
    const idVenda = obterParametroUrl("id");
    if (!idVenda) {
      mostrarAviso("ID da venda n√£o informado na URL.", "erro");
      return;
    }

    try {
      const resp = await fetch(`${API_VENDA}/${encodeURIComponent(idVenda)}`);
      if (!resp.ok) {
        throw new Error(`Erro ${resp.status} ao buscar venda.`);
      }
      const dados = await resp.json();

      vendaCarregada = dados;
      preencherInfoVenda(dados.venda);
      preencherInfoTransacao(dados.transacao);
    } catch (erro) {
      console.error(erro);
      mostrarAviso("Erro ao carregar dados da venda.", "erro");
    }
  }

  async function pagarParcelas() {
    if (!transacaoAtual || !transacaoAtual.idTransacao) {
      mostrarAviso("Transa√ß√£o n√£o carregada.", "erro");
      return;
    }

    const inputQtd = document.getElementById("input-qtd-parcelas");
    const qtd = Number(inputQtd.value);

    if (!qtd || qtd <= 0) {
      mostrarAviso("Informe uma quantidade v√°lida de parcelas.", "erro");
      return;
    }

    if (qtd > transacaoAtual.numeroDeParcelasNaoPagas) {
      mostrarAviso("Quantidade maior do que o n√∫mero de parcelas em aberto.", "erro");
      return;
    }

    const payload = {
      QuantidadeDeParcelasASerAtualizadaParaPaga: qtd,
      quantidadeDeParcelasASerAtualizadaParaPaga: qtd
    };

    console.log("üì§ Enviando PATCH com payload:", payload);

    try {
      const resp = await fetch(`${API_VENDA}/${encodeURIComponent(transacaoAtual.idTransacao)}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const texto = await resp.text();

      if (!resp.ok) {
        let msg = "Erro ao registrar pagamento.";

        try {
          const json = JSON.parse(texto);
          if (Array.isArray(json)) msg = json.join(" | ");
          else if (typeof json === "string") msg = json;
        } catch {
          if (texto) msg = texto;
        }

        throw new Error(msg);
      }

      mostrarAviso("Pagamento registrado com sucesso!", "sucesso");
      await carregarVenda();
    } catch (erro) {
      console.error("Erro no pagamento:", erro);
      mostrarAviso(erro.message, "erro");
    }
  }

  document.addEventListener("DOMContentLoaded", carregarVenda);
</script>
</body>
</html>
