<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Vendas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="home.html">Home</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">
              Menu
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_serviços.html">Serviços</a></li>
              <li><a class="dropdown-item active" href="buscar_vendas.html">Vendas</a></li>
              <li><a class="dropdown-item" href="relatorios.html">Relatórios</a></li>
            </ul>
          </li>
        </ul>
      </div>
      <img class="img-logo" src="./resources/ImagemLogoEmpresaParaEstagio.png" alt="logo da empresa">
    </div>
  </nav>

  <div class="container mt-5">
    <div class="form-box">

      <div class="d-flex justify-content-between align-items-end flex-wrap mb-4 gap-3">
        <h2 class="mb-0">Lista de Vendas</h2>
        <div class="d-flex align-items-center gap-2">
          <input
            type="text"
            id="input-buscar-cpf"
            class="form-control"
            style="max-width: 250px;"
            placeholder="Buscar por CPF ou Cod"
          >
          <button class="btn btn-primary" onclick="buscarPorCpf()">Buscar</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped text-center align-middle" id="tabela-vendas">
          <thead class="table-secondary">
            <tr>
              <th class="text-start ps-3">Código da Venda</th>
              <th class="text-start ps-3">Cliente</th>
              <th style="text-align: right; padding-right: 12px;">Documento (CPF/CNPJ)</th>
              <th class="text-end">Total da Venda (R$)</th>
              <th class="text-end">Total Pago (R$)</th>
              <th>Situação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="text-center text-muted">Carregando vendas...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <a href="vendas.html" 
     class="btn btn-success position-fixed bottom-0 end-0 m-4 rounded-circle shadow"
     style="width: 60px; height: 60px; font-size: 28px; display: flex; align-items: center; justify-content: center;">
     +
  </a>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "https://localhost:7036";

    let vendasCarregadas = [];    
    let filtroCpfAtual = "";      

    function mostrarAviso(msg, tipo) {
      const aviso = document.createElement("div");

      let classeAlert = "alert-warning";
      if (tipo === "sucesso") classeAlert = "alert-success";
      if (tipo === "erro") classeAlert = "alert-danger";

      aviso.className = `alert ${classeAlert} position-fixed top-0 end-0 m-3`;
      aviso.style.zIndex = "9999";
      aviso.textContent = msg;

      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 4000);
    }

    function obterNomeCliente(cliente) {
      if (!cliente) return "—";
      return cliente.nome || cliente.razaoSocial || "—";
    }

    function normalizarDocumento(doc) {
      if (!doc) return "";
      return doc.toString().replace(/\D/g, "");
    }

    function formatarDocumento(doc) {
      const d = normalizarDocumento(doc);

      if (d.length === 11) {
        return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }

      if (d.length === 14) {
        return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
      }

      return doc || "—";
    }

    function obterDocumentoCliente(cliente) {
      if (!cliente) return "—";
      const bruto = cliente.cpf || cliente.cnpj || "";
      return formatarDocumento(bruto);
    }

    function obterSituacao(transacao) {
      if (!transacao) return "—";
      if (transacao.pago) return "Paga";
      if (transacao.transacaoEmCurso) return "Em andamento";
      return "Em aberto";
    }

    function preencherTabela(vendasTransacoes) {
      const tbody = document.querySelector("#tabela-vendas tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(vendasTransacoes) || vendasTransacoes.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" class="text-center text-muted">Nenhuma venda encontrada.</td>`;
        tbody.appendChild(tr);
        return;
      }

      vendasTransacoes.forEach(vt => {
        const venda = vt.venda || {};
        const transacao = vt.transacao || {};

        const idVenda = venda.idVenda || venda.id || "";
        const codigoVenda = venda.codigoVenda ?? "-";
        const nomeCliente = obterNomeCliente(venda.cliente);
        const documentoCliente = obterDocumentoCliente(venda.cliente);
        const totalVenda = venda.valorTotalComDesconto ?? 0;
        const totalPago = transacao.valorPago ?? 0;
        const situacao = obterSituacao(transacao);

        const urlDetalhe = `venda_detalhe.html?id=${encodeURIComponent(idVenda)}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="text-start ps-3">${codigoVenda}</td>
          <td class="text-start ps-3">${nomeCliente}</td>
          <td style="text-align: right; padding-right: 12px;">${documentoCliente}</td>
          <td class="text-end">R$ ${totalVenda.toFixed(2)}</td>
          <td class="text-end">R$ ${totalPago.toFixed(2)}</td>
          <td>${situacao}</td>
          <td>
            <a href="${urlDetalhe}" class="btn btn-sm btn-primary">
              Visualizar
            </a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filtrarPorCpf(lista, cpfFiltro) {
      const filtroNumerico = normalizarDocumento(cpfFiltro);

      if (!filtroNumerico) {
        return lista; 
      }

      return lista.filter(vt => {
        const cliente = vt.venda?.cliente;
        if (!cliente) return false;

        const docCliente = normalizarDocumento(cliente.cpf || cliente.cnpj);
        if (!docCliente) return false;

        return docCliente.includes(filtroNumerico);
      });
    }

    async function carregarVendas() {
      const tbody = document.querySelector("#tabela-vendas tbody");
      tbody.innerHTML = `
        <tr><td colspan="7" class="text-center text-muted">Carregando vendas...</td></tr>
      `;

      try {
        const resp = await fetch(`${API_BASE}/api/venda`);
        if (!resp.ok) throw new Error(`Erro ${resp.status}: não foi possível carregar as vendas.`);

        const dados = await resp.json();
        vendasCarregadas = Array.isArray(dados) ? dados : [];

        const filtradas = filtrarPorCpf(vendasCarregadas, filtroCpfAtual);
        preencherTabela(filtradas);
      } catch (erro) {
        console.error(erro);
        tbody.innerHTML = `
          <tr><td colspan="7" class="text-center text-danger">Erro ao carregar vendas: ${erro.message}</td></tr>
        `;
        mostrarAviso("Erro ao buscar vendas. Verifique a API.", "erro");
      }
    }

    async function buscarPorCpf() {
      const termo = document.getElementById("input-buscar-cpf").value.trim();
      filtroCpfAtual = termo;

      const tbody = document.querySelector("#tabela-vendas tbody");

      if (termo === "") {
        const filtradas = filtrarPorCpf(vendasCarregadas, "");
        preencherTabela(filtradas);
        return;
      }

      tbody.innerHTML = `
        <tr><td colspan="7" class="text-center text-muted">Buscando vendas...</td></tr>
      `;

      try {
        const respCodigo = await fetch(
          `${API_BASE}/api/venda/buscar-venda-por-codigo-venda/${encodeURIComponent(termo)}`
        );

        if (respCodigo.ok) {
          const dados = await respCodigo.json();
          const lista = Array.isArray(dados) ? dados : (dados ? [dados] : []);

          if (lista.length > 0) {
            preencherTabela(lista);
            return; 
          }
        }

        const filtradas = filtrarPorCpf(vendasCarregadas, termo);
        preencherTabela(filtradas);

      } catch (erro) {
        console.error("Erro na busca por código da venda, usando CPF/CNPJ como fallback:", erro);
        const filtradas = filtrarPorCpf(vendasCarregadas, termo);
        preencherTabela(filtradas);
      }
    }

    document.addEventListener("DOMContentLoaded", carregarVendas);
  </script>
</body>
</html>
