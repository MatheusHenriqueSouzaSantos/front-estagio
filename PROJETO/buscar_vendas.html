<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Vendas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Se quiser, faça um CSS parecido com o de clientes -->
  <link rel="stylesheet" href="css/styleVendas.css">
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">Home</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle mt-1" href="#" role="button" data-bs-toggle="dropdown">
              Menu
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="buscar_clientes.html">Clientes</a></li>
              <li><a class="dropdown-item" href="buscar_produtos.html">Produtos</a></li>
              <li><a class="dropdown-item" href="buscar_serviços.html">Serviços</a></li>
              <li><a class="dropdown-item active" href="buscar_vendas.html">Vendas</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTEÚDO -->
  <div class="container my-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="text-center mb-4">Lista de Vendas</h2>

        <div class="table-responsive">
          <table class="table table-striped text-center align-middle" id="tabela-vendas">
            <thead class="table-secondary">
              <tr>
                <th>ID Venda</th>
                <th>Cliente</th>
                <th>Total da Venda (R$)</th>
                <th>Total Pago (R$)</th>
                <th>Situação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

     <a href="vendas.html" class="botao-add">
        <span>+</span>
    </a>


  <!-- BOOTSTRAP -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "https://localhost:7036";

    function mostrarAviso(msg, tipo) {
      const aviso = document.createElement("div");
      aviso.className = `alert ${tipo === "sucesso" ? "alert-success" : "alert-warning"} position-fixed top-0 end-0 m-3`;
      aviso.style.zIndex = "9999";
      aviso.textContent = msg;
      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 4000);
    }

    function obterNomeCliente(cliente) {
      if (!cliente) return "—";
      return cliente.nome || cliente.razaoSocial || "—";
    }

    function obterSituacao(transacao) {
      if (!transacao) return "—";
      if (transacao.pago) return "Paga";
      if (transacao.transacaoEmCurso) return "Em andamento";
      return "Em aberto";
    }

    function preencherTabela(vendasTransacoes) {
      const tbody = document.querySelector("#tabela-vendas tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(vendasTransacoes) || vendasTransacoes.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="text-center text-muted">Nenhuma venda encontrada.</td>`;
        tbody.appendChild(tr);
        return;
      }

      vendasTransacoes.forEach(vt => {
        // Estrutura: { venda: VendaOutputDto, transacao: TransacaoOutputDto }
        const venda = vt.venda || {};
        const transacao = vt.transacao || {};

        const idVenda = venda.idVenda || "";
        const nomeCliente = obterNomeCliente(venda.cliente);
        const totalVenda = venda.valorTotalComDescontoAplicado ?? 0;
        const totalPago = transacao.valorPago ?? 0;
        const situacao = obterSituacao(transacao);

        const urlDetalhe = `venda_detalhe.html?id=${encodeURIComponent(idVenda)}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idVenda}</td>
          <td>${nomeCliente}</td>
          <td>R$ ${totalVenda.toFixed(2)}</td>
          <td>R$ ${totalPago.toFixed(2)}</td>
          <td>${situacao}</td>
          <td>
            <a href="${urlDetalhe}" class="btn btn-sm btn-primary">
              Visualizar
            </a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function carregarVendas() {
      const tbody = document.querySelector("#tabela-vendas tbody");
      tbody.innerHTML = `
        <tr><td colspan="6" class="text-center text-muted">Carregando vendas...</td></tr>
      `;

      try {
        const resp = await fetch(`${API_BASE}/api/venda`);
        if (!resp.ok) throw new Error(`Erro ${resp.status}: não foi possível carregar as vendas.`);
        const dados = await resp.json();
        preencherTabela(dados);
      } catch (erro) {
        console.error(erro);
        tbody.innerHTML = `
          <tr><td colspan="6" class="text-center text-danger">Erro ao carregar vendas: ${erro.message}</td></tr>
        `;
        mostrarAviso("Erro ao buscar vendas. Verifique a API.", "erro");
      }
    }

    document.addEventListener("DOMContentLoaded", carregarVendas);
  </script>
</body>
</html>
